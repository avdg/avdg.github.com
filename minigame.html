<!DOCTYPE html>
<html><head><script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script><script type="text/javascript">
(function(){var achievements,cache,draw,game,gcd,getImage,init,keyHandler,settings,shuffle,solveFlooredRatio,solveRatio,state,tetris;settings={locale:false,debug:false,style:"srs"};cache={_:false,blockTypes:"ijlotsz".split(""),blocks:{srs:{rotate:function(position){return[position[1],-position[0]]},derotate:function(position){return[-position[1],position[0]]},opposite:function(position){return[-position[0],-position[1]]},initials:{i:[[0,-1],[0,0],[0,1],[0,2]],j:[[-1,-1],[0,-1],[0,0],[0,1]],l:[[0,-1],[0,0],[0,1],[-1,1]],o:[[-1,0],[0,0],[-1,1],[0,1]],s:[[0,-1],[0,0],[-1,0],[-1,1]],t:[[-1,0],[0,-1],[0,0],[0,1]],z:[[-1,-1],[-1,0],[0,0],[0,1]]},kickTable:{right:{o:[[],[],[],[]],i:[[[-2,0],[1,0],[-2,-1],[1,2]],[[-1,0],[2,0],[-1,2],[2,-1]],[[2,0],[-1,0],[2,1],[-1,-2]],[[1,0],[-2,0],[1,-2],[-2,1]]],"default":[[[-1,0],[-1,1],[0,-2],[-1,-2]],[[1,0],[1,-1],[0,2],[1,2]],[[1,0],[1,1],[0,-2],[1,-2]],[[-1,0],[-1,-1],[0,2],[-1,2]]]},left:{o:[[],[],[],[]],i:[[[2,0],[-1,0],[2,1],[-1,-2]],[[1,0],[-2,0],[1,-2],[-2,1]],[[-2,0],[1,0],[-2,-1],[1,2]],[[-1,0],[2,0],[-1,2],[2,-1]]],"default":[[[1,0],[1,-1],[0,2],[1,2]],[[-1,0],[-1,1],[0,-2],[-1,2]],[[-1,0],[-1,-1],[0,2],[-1,2]],[[1,0],[1,1],[0,-2],[1,-2]]]}},offsets:{i:[[[0,0],[-1,0],[2,0],[-1,0],[2,0]],[[-1,0],[0,0],[0,0],[0,1],[0,-2]],[[-1,2],[1,1],[-2,1],[1,0],[-2,0]],[[0,1],[0,1],[0,1],[0,-1],[0,2]]],o:[[[0,0]],[[0,-1]],[[-1,-1]],[[-1,0]]],"default":[[[0,0],[0,0],[0,0],[0,0],[0,0]],[[0,0],[1,0],[1,-1],[0,2],[1,2]],[[0,0],[0,0],[0,0],[0,0],[0,0]],[[0,0],[-1,0],[-1,1],[0,2],[-1,2]]]},color:{i:"rgba(0,255,255,.9)",j:"rgba(0,0,255,.9)",l:"rgba(255,170,0,.9)",o:"rgba(255,255,0,.9)",s:"rgba(0,255,0,.9)",t:"rgba(153,0,255,.9)",z:"rgba(255,0,0,.9)"},blocks:{}}},images:{cache:{},links:{clown:"http://tweakers.net/ext/f/QiUS8Q3QxzG4yC76TOl0RSHI/full.jpg",nature:"http://www.finewallpaperss.com/wp-content/uploads/2012/09/green-nature-wallpaper1.jpg"},offline:{clown:"img/clown.jpg",nature:"img/green-nature-wallpaper.jpg"}}};init=function(){var i,j,k,l,_i,_j,_k,_len,_ref,_ref1,_step;if(cache._){return}getImage("clown");if(!window.requestAnimationFrame){window.requestAnimationFrame=function(){return window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(callback){window.setTimeout(callback,1e3/60)}}()}_ref=cache.blockTypes;for(_i=0,_len=_ref.length,_step=1;_i<_len;_i+=_step){i=_ref[_i];l=cache.blocks.srs.initials[i].slice(0);cache.blocks.srs.blocks[i]=[];for(j=_j=0;_j<4;j=_j+=1){cache.blocks.srs.blocks[i][j]=$.extend(true,[],l);for(k=_k=0,_ref1=cache.blocks.srs.initials[i].length;_k<_ref1;k=_k+=1){l[k]=cache.blocks.srs.rotate(l[k])}}}cache._=true};achievements=function(){function achievements(){this.achievements={}}achievements.prototype.add=function(achievement,msg){this.achievement[achievement]={msg:msg,unlocked:false}};achievements.prototype.unlock=function(achievement){if(this.achievement[achievement].unlocked=false){this.achievement[achievement].unlocked=true;return true}return false};achievements.prototype.unlocked=function(achievement){return this.achievement[achievement].unlocked};return achievements}();state=function(){function state(){this.resetState(true)}state.prototype.resetState=function(updateSettings){var i,j,_i,_j,_k;if(updateSettings==null){updateSettings=false}this.activeBlock={block:null,rotation:null,w:null,h:null};this.display=[];this.wall=0;this.lineOffsets=[];this.hold=null;this.holdDisabled=false;this.holdLock=false;this.queue=[];this.totalLines=0;this.totalBlocksDropped=0;this.linesSingle=0;this.linesDouble=0;this.linesTriple=0;this.linesQuadro=0;this.lastLineType=null;this.lastLineIsTSpin=false;this.combo=0;this.maxCombo=0;this.backToBackTetrisCombo=0;this.backToBackTSpin=0;if(updateSettings){this.settings=$["extend"](true,{},settings)}this.rotationStyle="srs";for(i=_i=0;_i<24;i=++_i){this.display[i]=[];for(j=_j=0;_j<10;j=++_j){this.display[i][j]=null}}for(i=_k=0;_k<20;i=++_k){this.lineOffsets[i]=0}this.fillQueue();this.nextBlock()};state.prototype.fillQueue=function(n){if(n==null){n=7}while(this.queue.length<n){this.queue=this.queue.concat(shuffle(cache.blockTypes))}};state.prototype.nextBlock=function(n,queueLength){var i,_i;if(n==null){n=1}if(queueLength==null){queueLength=7}for(i=_i=0;_i<n;i=_i+=1){this.activeBlock.block=this.queue.shift();this.activeBlock.rotation=0;this.activeBlock.h=18;this.activeBlock.w=4;if(this.queue.length<queueLength){this.fillQueue(queueLength)}}};state.prototype.tryActiveBlockPosition=function(x,y,blocks){var i,_i,_ref;for(i=_i=0,_ref=blocks.length;_i<_ref;i=_i+=1){if(y-blocks[i][0]<0||y-blocks[i][0]>=20){return false}if(x+blocks[i][1]<0||x+blocks[i][1]>=10){return false}if(this.display[y-blocks[i][0]][x+blocks[i][1]]!==null){return false}}return true};state.prototype.storeBlock=function(){var _ref;if(this.holdDisabled||this.holdLock){return}if(this.hold===null){this.hold=this.activeBlock.block;this.nextBlock()}else{_ref=[this.activeBlock.block,this.hold],this.hold=_ref[0],this.activeBlock.block=_ref[1];this.activeBlock.rotation=0;this.activeBlock.h=18;this.activeBlock.w=4}this.holdLock=true;this.updateDisplay()};state.prototype.moveLeft=function(){if(this.tryActiveBlockPosition(this.activeBlock.w-1,this.activeBlock.h,cache.blocks.srs.blocks[this.activeBlock.block][this.activeBlock.rotation])){this.activeBlock.w-=1;this.updateDisplay()}};state.prototype.moveRight=function(){if(this.tryActiveBlockPosition(this.activeBlock.w+1,this.activeBlock.h,cache.blocks.srs.blocks[this.activeBlock.block][this.activeBlock.rotation])){this.activeBlock.w+=1;this.updateDisplay()}};state.prototype.moveDown=function(){if(this.tryActiveBlockPosition(this.activeBlock.w,this.activeBlock.h-1,cache.blocks.srs.blocks[this.activeBlock.block][this.activeBlock.rotation])){this.activeBlock.h-=1;this.updateDisplay()}else{this.lock()}};state.prototype.doDrop=function(){while(this.tryActiveBlockPosition(this.activeBlock.w,this.activeBlock.h-1,cache.blocks.srs.blocks[this.activeBlock.block][this.activeBlock.rotation])){this.activeBlock.h-=1}this.lock()};state.prototype.rotateRight=function(){var rotation;rotation=(this.activeBlock.rotation+1)%4;if(this.tryActiveBlockPosition(this.activeBlock.w,this.activeBlock.h,cache.blocks.srs.blocks[this.activeBlock.block][rotation])){this.activeBlock.rotation=rotation;this.updateDisplay()}};state.prototype.rotateLeft=function(){var rotation;rotation=(this.activeBlock.rotation+3)%4;if(this.tryActiveBlockPosition(this.activeBlock.w,this.activeBlock.h,cache.blocks.srs.blocks[this.activeBlock.block][rotation])){this.activeBlock.rotation=rotation;this.updateDisplay()}};state.prototype.lock=function(){var blocks,i,_i,_ref;this.holdLock=false;this.totalBlocksDropped+=1;blocks=cache.blocks.srs.blocks[this.activeBlock.block][this.activeBlock.rotation];for(i=_i=0,_ref=blocks.length;_i<_ref;i=_i+=1){this.display[this.activeBlock.h-blocks[i][0]][this.activeBlock.w+blocks[i][1]]=cache.blocks.srs.color[this.activeBlock.block]}this.removeLines(this.activeBlock.type);this.nextBlock();if(!this.tryActiveBlockPosition(this.activeBlock.w,this.activeBlock.h,cache.blocks.srs.blocks[this.activeBlock.block][this.activeBlock.rotation])){this.resetState()}this.updateDisplay()};state.prototype.removeLines=function(lockedBlockType){var fullLine,i,j,lines,_i,_j,_ref,_ref1;lines=0;for(i=_i=0,_ref=this.display.length;_i<_ref;i=_i+=1){fullLine=true;for(j=_j=0,_ref1=this.display[i].length;_j<_ref1;j=_j+=1){this.display[i-lines][j]=this.display[i][j];if(this.display[i][j]===null){fullLine=false}}if(fullLine){lines+=1}}this.totalLines+=lines;switch(lines){case 1:this.linesSingle+=1;this.lastLineType="single";if(lockedBlockType==="t"){"test"}break;case 2:this.linesDouble+=1;this.lastLineType="double";if(lockedBlockType==="t"){"test"}break;case 3:this.linesTriple+=1;this.lastLineType="triple";if(lockedBlockType==="t"){"test"}break;case 4:if(this.lastLineType==="quadro"){this.backToBackTetrisCombo+=1}else{this.lastLineType="quadro"}this.linesQuadro+=1;this.lastLineIsTSpin=false}this.updateDisplay()};state.prototype.updateDisplay=function(){};state.prototype.gameOver=function(){};return state}();draw=function(){function draw(x,y,w,h,c,s){this.resetSettings();this.x=x;this.y=y;this.w=w;this.h=h;this.c=c;this.s=s;this.c.lineWidth=0}draw.prototype.resetSettings=function(){this.options={defaultClearColor:"rgb(255, 255, 255)",defaultBlockColor:"rgba(0, 0, 0, .5)",defaultBgColor:"rgb(0, 0, 0)",defaultBlockBgColor:"rgba(255, 255, 255, .3)",defaultGridBgColor:"rgba(255, 255, 255, .5)",image:"clown",rows:20,cols:10,ghostBlock:true}};draw.prototype.clearScreen=function(color){if(color==null){color=this.options.defaultClearColor}this.c.fillStyle=color;this.c.fillRect(this.x,this.y,this.w,this.h)};draw.prototype.drawImageBackground=function(x,y,w,h,options){var bH,bW,blockSize,image,r,_ref,_ref1;if(options==null){options={}}blockSize=24;bW=w/blockSize;bH=h/blockSize;r=bW/2;image=getImage((_ref=options.image)!=null?_ref:this.options.image);this.c.beginPath();this.c.strokeStyle=this.c.fillStyle=(_ref1=options.defaultBgColor)!=null?_ref1:this.options.defaultBgColor;this.c.lineWidth=1;this.c.moveTo(x+bW*2,y+bH);this.c.arcTo(x+bW*23,y+bH,x+bW*23,y+bH*2,r);this.c.arcTo(x+bW*23,y+bH*23,x+bW*22,y+bH*23,r);this.c.arcTo(x+bW,y+bH*23,x+bW,y+bH*22,r);this.c.arcTo(x+bW,y+bH,x+bW*2,y+bH,r);this.c.closePath();this.c.clip();this.c.drawImage(image,x+bW,y+bH,w-bW,h-bH);this.c.restore();this.c.lineWidth=0};draw.prototype.drawGameGrid=function(x,y,w,h,options){var bH,bW,cols,defaultBlockColor,defaultGridBgColor,drawBH,ghostH,i,j,offsetBottom,rows,tempX,tempY,_i,_j,_k,_l,_m,_ref,_ref1,_ref2,_ref3,_ref4;if(options==null){options={}}rows=(_ref=options.rows)!=null?_ref:this.options.rows;cols=(_ref1=options.cols)!=null?_ref1:this.options.cols;defaultBlockColor=(_ref2=options.defaultBlockColor)!=null?_ref2:this.options.defaultBlockColor;defaultGridBgColor=(_ref3=options.defaultGridBgColor)!=null?_ref3:this.options.defaultGridBgColor;bH=h/rows;bW=w/cols;this.c.fillStyle=defaultGridBgColor;this.c.fillRect(x,y,w,h);this.c.fillStyle=defaultBlockColor;for(i=_i=0;_i<rows;i=_i+=1){for(j=_j=0;_j<cols;j=_j+=1){this.c.fillRect(x+bW*j+1,y+bH*i+1,bW-2,bH-2)}}ghostH=this.s.activeBlock.h;while(this.s.tryActiveBlockPosition(this.s.activeBlock.w,ghostH-1,cache.blocks.srs.blocks[this.s.activeBlock.block][this.s.activeBlock.rotation])){ghostH-=1}offsetBottom=0;drawBH=bH;for(i=_k=0;_k<rows;i=_k+=1){offsetBottom+=bH+this.s.lineOffsets[i];if(offsetBottom>h+.05){break}else if(offsetBottom+bH>h+.05){drawBH=offsetBottom+bH-h}for(j=_l=0;_l<cols;j=_l+=1){if(this.s.display[i][j]!==null){this.c.fillStyle=this.s.display[i][j];this.c.fillRect(x+bW*j+1,y+h-offsetBottom+1,bW-2,drawBH-2)}}for(j=_m=0,_ref4=cache.blocks.srs.blocks[this.s.activeBlock.block][this.s.activeBlock.rotation].length;_m<_ref4;j=_m+=1){if(this.s.activeBlock.h-cache.blocks.srs.blocks[this.s.activeBlock.block][this.s.activeBlock.rotation][j][0]===i){this.c.fillStyle=cache.blocks.srs.color[this.s.activeBlock.block];this.c.fillRect(x+bW*(cache.blocks.srs.blocks[this.s.activeBlock.block][this.s.activeBlock.rotation][j][1]+this.s.activeBlock.w)+1,y+h-offsetBottom+1,bW-2,bH-2)}else if(ghostH-cache.blocks.srs.blocks[this.s.activeBlock.block][this.s.activeBlock.rotation][j][0]===i&&this.options.ghostBlock){tempX=x+bW*(cache.blocks.srs.blocks[this.s.activeBlock.block][this.s.activeBlock.rotation][j][1]+this.s.activeBlock.w);tempY=y+h-offsetBottom;this.c.lineWidth=2;this.c.strokeStyle=cache.blocks.srs.color[this.s.activeBlock.block];this.c.beginPath();this.c.moveTo(tempX+1,tempY+1);this.c.lineTo(tempX+bW-2,tempY+1);this.c.lineTo(tempX+bW-2,tempY+bH-2);this.c.lineTo(tempX+1,tempY+bH-2);this.c.closePath();this.c.stroke();this.c.lineWdith=0}}}};draw.prototype.drawBox=function(x,y,w,h,typeOrGrid,options){var blockColor,blockH,blockW,defaultBlockColor,hTotal,i,maxH,maxW,minH,minW,offsetX,offsetY,wTotal,_i,_j,_ref,_ref1,_ref2,_ref3,_ref4,_ref5;if(options==null){options={}}defaultBlockColor=(_ref=options.defaultBlockBgColor)!=null?_ref:this.options.defaultBlockBgColor;blockW=w/4;blockH=h/4;if(typeof typeOrGrid==="string"){blockColor=(_ref1=(_ref2=options.blockColor)!=null?_ref2:cache.blocks.srs.color[typeOrGrid])!=null?_ref1:this.options.defaultBlockColor;typeOrGrid=cache.blocks.srs.blocks[typeOrGrid][0]}else{blockColor=(_ref3=options.blockColor)!=null?_ref3:this.options.defaultBlockColor}this.c.fillStyle=defaultBlockColor;this.c.fillRect(x,y,w,h);if(typeOrGrid===null){return}minH=maxH=typeOrGrid[0][0];minW=maxW=typeOrGrid[0][1];for(i=_i=1,_ref4=typeOrGrid.length;_i<_ref4;i=_i+=1){if(typeOrGrid[i][0]<minH){minH=typeOrGrid[i][0]}else if(typeOrGrid[i][0]>maxH){maxH=typeOrGrid[i][0]}if(typeOrGrid[i][1]<minW){minW=typeOrGrid[i][1]}else if(typeOrGrid[i][1]>maxW){maxW=typeOrGrid[i][1]}}wTotal=maxW-minW+1;hTotal=maxH-minH+1;offsetX=(4-wTotal)/2*blockW;offsetY=(4-hTotal)/2*blockH;this.c.fillStyle=blockColor;for(i=_j=0,_ref5=typeOrGrid.length;_j<_ref5;i=_j+=1){this.c.fillRect(x+offsetX+(typeOrGrid[i][1]-minW)*blockW+1,y+offsetY+(typeOrGrid[i][0]-minH)*blockH+1,blockW-2,blockH-2)}};draw.prototype.draw=function(){var bH,bW,t;t=(new Date).getDate();bW=this.w/24;bH=this.h/24;this.clearScreen();this.drawImageBackground(this.x,this.y,this.w,this.h);this.drawGameGrid(this.x+bW*7,this.y+bH*2,bW*10,bH*20);this.drawBox(this.x+bW*18,this.y+bH*2,bW*4,bH*4,this.s.queue[0]);this.drawBox(this.x+bW*18,this.y+bH*7,bW*4,bH*4,this.s.queue[1]);this.drawBox(this.x+bW*18,this.y+bH*12,bW*4,bH*4,this.s.queue[2]);this.drawBox(this.x+bW*18,this.y+bH*17,bW*4,bH*4,this.s.queue[3]);this.drawBox(this.x+bW*2,this.y+bH*2,bW*4,bH*4,this.s.hold);if(settings.debug){console.debug((new Date).getDate()-t+" ms spend drawing")}};return draw}();keyHandler=function(){function keyHandler(register){var _this=this;if(register==null){register=true}this.keys={keyUp:{},keyDown:{},keyPress:{}};this.keyDownFunction=function(e){return _this.onKeyDown(e)};this.keyUpFunction=function(e){return _this.onKeyUp(e)};this.keyPressFunction=function(e){return _this.onKeyPress(e)};if(register){this.registerEventHandlers()}return}keyHandler.prototype.registerEventHandlers=function(){document.addEventListener("keydown",this.keyDownFunction,false);document.addEventListener("keyup",this.keyUpFunction,false);document.addEventListener("keypress",this.keyPressFunction,false)};keyHandler.prototype.unregisterEventHandlers=function(){document.removeEventListener("keydown",this.keyDownFunction,false);document.removeEventListener("keyup",this.keyUpFunction,false);document.removeEventListener("keypress",this.keyPressFunction,false)};keyHandler.prototype.registerKeyDown=function(keyCode,f){this.keys.keyDown[keyCode]=f};keyHandler.prototype.registerKeyUp=function(keyCode,f){this.keys.keyUp[keyCode]=f};keyHandler.prototype.registerKeyPress=function(keyCode,f){this.keys.keyPress[keyCode]=f};keyHandler.prototype.onKeyDown=function(e){var keyCode;keyCode=e.which;if(typeof this.keys.keyDown[keyCode]==="function"){return this.keys.keyDown[keyCode](e)}else if(typeof this.keys.keyDown["default"]==="function"){return this.keys.keyDown["default"]}};keyHandler.prototype.onKeyUp=function(e){var keyCode;keyCode=e.which;if(typeof this.keys.keyUp[keyCode]==="function"){return this.keys.keyUp[keyCode](e)}else if(typeof this.keys.keyUp["default"]==="function"){return this.keys.keyUp["default"]}};keyHandler.prototype.onKeyPress=function(e){var keyCode;keyCode=e.which;if(typeof this.keys.keyPress[keyCode]==="function"){return this.keys.keyPress[keyCode](e)}else if(typeof this.keys.keyPress["default"]==="function"){return this.keys.keyPress["default"]}};return keyHandler}();shuffle=function(input){var i,j,list,t,_i,_ref;list=$.extend(true,[],input);for(i=_i=1,_ref=list.length;_i<_ref;i=_i+=1){j=Math.floor(Math.random()*(i+1));t=list[i];list[i]=list[j];list[j]=t}return list};gcd=function(a,b){var _ref;while(b!==0){_ref=[b,a%b],a=_ref[0],b=_ref[1]}return a};solveRatio=function(w,h,w2,h2){if(w/h<w2/h2){h2=h*w2/w}else{w2=w*h2/h}return[w2,h2]};solveFlooredRatio=function(w,h,w2,h2){if(w/h<w2/h2){w2=w2-w2%gcd(w,h);h2=h*w2/w}else{h2=h2-h2%gcd(h,w);w2=w*h2/h}return[w2,h2]};getImage=function(image){return cache.images.cache[image]||(cache.images.cache[image]=new Image,cache.images.cache[image].src=cache.images[settings.locale?"offline":"links"][image],cache.images.cache[image])};tetris=function(){function tetris(element){var _this=this;init();if(element==null){element="game"}this.c=document.getElementById(element).getContext("2d");this.state=new state;if(settings.debug){this.cache=cache}this.drawer=new draw(0,0,this.c.canvas.width,this.c.canvas.height,this.c,this.state);this.keyHandler=new keyHandler;this.doDraw=false;this.state.updateDisplay=function(){if(_this.doDraw===false){window.requestAnimationFrame(function(){_this.doDraw=false;return _this.drawer.draw()});_this.doDraw=true}};this.keyHandler.registerKeyDown(37,function(e){_this.state.moveLeft();e.preventDefault();return false});this.keyHandler.registerKeyDown(38,function(e){_this.state.rotateRight();e.preventDefault();return false});this.keyHandler.registerKeyDown(39,function(e){_this.state.moveRight();e.preventDefault();return false});this.keyHandler.registerKeyDown(40,function(e){_this.state.moveDown();e.preventDefault();return false});this.keyHandler.registerKeyDown(32,function(e){_this.state.doDrop();e.preventDefault();return false});this.keyHandler.registerKeyDown(16,function(e){_this.state.storeBlock();e.preventDefault();return false});this.keyHandler.registerKeyDown(17,function(e){_this.state.rotateLeft();e.preventDefault();return false});this.draw();getImage("clown").onload=function(){return _this.draw()}}tetris.prototype.draw=function(){this.drawer.draw()};return tetris}();game=null;$(document)["ready"](function(){var t;t=(new Date).getDate();window.game=game=new tetris;if(settings.debug){console.debug((new Date).getDate()-t+" ms to launch game")}})}).call(this);
var _gaq=_gaq||[]
_gaq.push(["_setAccount","UA-37350177-1"]),_gaq.push(["_trackPageview"]),function(){var t,e=document.createElement("script")
e.type="text/javascript",e.async=!0,e.src=("https:"==document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js",t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)}()</script></head><body><canvas id="game" width="528" height="528"></canvas><br><a href="https://github.com/avdg/avdg.github.com/issues">Send feedback</a></body></body></html>
